Private Sub Workbook_Open()
    Dim userName As String
    userName = Application.UserName  ' Get the current Office account user name

    Dim req As Object
    Set req = CreateObject("MSXML2.XMLHTTP")

    ' URL of your Django API endpoint with name parameter
    Dim url As String
    url = "http://127.0.0.1:8000/api/check_access/?name=" & userName

    ' Step 1: Establish connection with the server
    On Error GoTo ConnectionError
    MsgBox "Attempting to connect to the server..."
    req.Open "GET", url, False
    req.Send

    ' Step 2: Get the response from the server
    Dim response As String
    response = req.responseText
    MsgBox "Server response received: " & response

    ' Step 3: Parse the JSON response
    Dim jsonResponse As Object
    Set jsonResponse = JsonConverter.ParseJson(response) ' Ensure you have JSON Converter in your project

    ' Check the response status
    If jsonResponse("status") = "granted" Then
        MsgBox "Access granted for user: " & userName
    ElseIf jsonResponse("status") = "denied" Then
        MsgBox "Access denied for user: " & userName & ". Closing workbook."
        ThisWorkbook.Close SaveChanges:=False
    Else
        MsgBox "Error: " & jsonResponse("message") & vbCrLf & "Details: " & jsonResponse("details")
        ThisWorkbook.Close SaveChanges:=False
    End If

    Exit Sub

ConnectionError:
    MsgBox "Failed to connect to the server. Please check if the server is running and accessible.", vbCritical
    ThisWorkbook.Close SaveChanges:=False
End Sub
